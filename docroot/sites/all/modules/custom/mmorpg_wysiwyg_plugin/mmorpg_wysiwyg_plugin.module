<?php
/**
 * @file
 * Provide custom shortcodes for mmorpg.com
 */

/**
 * Implementation of hook_js_alter().
 * Replace the shortcode_wysiwwyg.js with our custom version
 */
function mmorpg_wysiwyg_plugin_js_alter(&$javascript) {
  $path = drupal_get_path('module', 'mmorpg_wysiwyg_plugin') . '/plugins/shortcode_wysiwyg/shortcode_wysiwyg.js';
  if( isset($javascript[$path]) ) {
    $javascript[$path]['data'] = drupal_get_path('module', 'mmorpg_wysiwyg_plugin') . '/shortcode_wysiwyg.js';
  }
}

/**
 * Implementation of hook_shortcode_info().
 */
function mmorpg_wysiwyg_plugin_shortcode_info() {
  $shortcodes = array();

  $shortcodes['poll'] = array(
    'title' => t('Add poll'),
    'description' => t('Creates a poll.'),
    'process callback' => 'mmorpg_wysiwyg_plugin_sortcode_poll',
    'tips callback' => 'mmorpg_wysiwyg_plugin_shortcode_poll_tips',
    'default settings' => array(),
    'attributes callback' => 'mmorpg_wysiwyg_plugin_shortcode_poll_attributes',
  );

  $shortcodes['related-content'] = array(
    'title' => t('Related Content'),
    'description' => t('Add related content.'),
    'process callback' => 'mmorpg_wysiwyg_plugin_sortcode_related_content',
    'tips callback' => 'mmorpg_wysiwyg_plugin_shortcode_related_content_tips',
    'default settings' => array(),
    'attributes callback' => 'mmorpg_wysiwyg_plugin_shortcode_related_content_attributes',
  );

  $shortcodes['play-now'] = array(
    'title' => t('Play Now'),
    'description' => t('Add play now.'),
    'process callback' => 'mmorpg_wysiwyg_plugin_sortcode_play_now',
    'tips callback' => 'mmorpg_wysiwyg_plugin_shortcode_play_now_tips',
    'default settings' => array(),
//    'attributes callback' => 'mmorpg_wysiwyg_plugin_shortcode_play_now_attributes',
  );

  return $shortcodes;
}

/**
 * Implementation of hook_theme().
 */
function mmorpg_wysiwyg_plugin_theme() {
  return array(
    'poll' => array(
      'variables' => array( 'text' => '', 'class' => ''),
    ),
    'related_content' => array(
      'variables' => array( 'text' => '', 'class' => ''),
    ),
  );
}

/*============================================================================================*/
/* Embed Poll
/*============================================================================================*/
function mmorpg_wysiwyg_plugin_sortcode_poll($attrs, $text) {
  extract(shortcode_attrs(array(
    'poll_id' => '',
    'class' => '',
  ), $attrs));

  if(isset($attrs['poll_id'])) {
    $poll_id = $attrs['poll_id'];
    $pollim = pollim_load($poll_id);
    if(is_object($pollim)) {
      $poll = pollim_page_view($pollim);
      return render($poll);
    }
  }
}

function mmorpg_wysiwyg_plugin_shortcode_poll_tips() {
  $output = '<strong>[poll poll_id="POLL ID HERE"][/poll]</strong>';

  return $output;
}

function mmorpg_wysiwyg_plugin_shortcode_poll_attributes($form, $form_state) {
  $form['poll_id'] = array(
    '#type' => 'textfield',
    '#title' => t('Poll ID'),
    '#size' => 60,
    '#maxlength' => 60,
    '#states' => array(
      'visible' => array(
        ':input[name="shortcode"]' => array('value' => 'poll'),
      ),
    ),
  );
  return $form;
}

/*============================================================================================*/
/* Embed Related Content
/*============================================================================================*/
function mmorpg_wysiwyg_plugin_sortcode_related_content($attrs, $text) {
  return '[related-content][/related-content]';
}

function mmorpg_wysiwyg_plugin_shortcode_related_content_tips() {
  $output = '<strong>[related-content][/related-content]</strong>';

  return $output;
}

function mmorpg_wysiwyg_plugin_shortcode_related_content_attributes($form, $form_state) {
  $form = array();
  return $form;
}

/*============================================================================================*/
/* Embed Play Now
/*============================================================================================*/
function mmorpg_wysiwyg_plugin_sortcode_play_now($attrs, $text) {
  return '';
  $content = '';
  if (arg(0) == 'node' && is_numeric(arg(1))) {
    // Get the nid
    $node_id = arg(1);

    $query_play_now = db_select('field_data_field_article_game', 'fdag');
    $query_play_now->join('field_data_field_game_contents', 'fdgc', 'fdgc.field_game_contents_target_id = fdag.field_article_game_target_id');
    $query_play_now->join('field_data_field_target_url', 'fdtu', 'fdtu.entity_id = fdgc.entity_id');
    $result_play_now = $query_play_now
      ->fields('fdtu', array('field_target_url_title', 'field_target_url_clickmeter_link'))
      ->condition('fdag.entity_id', $node_id)
      ->range(0,1)
      ->execute();

    $query_official_site = db_select('field_data_field_article_game', 'fdag');
    $query_official_site->join('field_data_field_link', 'fdl', 'fdl.entity_id = fdag.field_article_game_target_id' );
    $result_official_site = $query_official_site
      ->fields('fdl', array('field_link_url'))
      ->condition('fdag.entity_id', $node_id)
      ->range(0,1)
      ->execute();

    foreach ($result_official_site as $row) {
      if (!empty($row->field_link_url)) {
        $official_website_url = $row->field_link_url;
      }
    }

    foreach ($result_play_now as $row) {
      if (!empty($row->field_target_url_clickmeter_link) && !empty($row->field_target_url_title)) {
        $content .= "<a target='_blank' href=" . $row->field_target_url_clickmeter_link . ">" . $row->field_target_url_title . "</a></li></ul>";
      }
      else if (!empty($official_website_url) && !empty($row->field_target_url_title)) {
        $content .= "<a target='_blank' href=" . $official_website_url .">" . $row->field_target_url_title . "</a></li></ul>";
      }
    }
    if ($content == '' && !empty($official_website_url)) {
      $content .= "<a target='_blank' href=" . $row->field_link_url .">Play Now</a></li></ul>";
    }
    return $content;
  }
  else {
    return '';
  }
}

function mmorpg_wysiwyg_plugin_shortcode_play_now_tips() {
  $output = '<strong>[play-now][/play-now]</strong>';

  return $output;
}