<?php
/**
 * @file
 * Code for the MMORPG Site Configs feature.
 */

include_once 'mmorpg_site.features.inc';

/**
 * Implements hook_init().
 */
function mmorpg_site_init() {
  $categories = array(
    'game' => 'games',
  );

  $node = menu_get_object();
  if (!$node) {
    return;
  }
  if (array_key_exists($node->type, $categories)) {
    drupal_add_js(array(
      'MMORPG_page_viewed' => array(
        'type' => 'single',
        'section' => $categories[$node->type],
        'id' => $node->nid,
      )
    ), 'setting');
  }
}

/**
 * Implements hook_menu().
 */
function mmorpg_site_menu() {

  $items['admin/mmorpg/reports'] = array(
    'title' => 'Reports',
    'description' => 'Access various advt. reports',
    'access callback' => TRUE,
    'type' => MENU_LOCAL_TASK,
  );

  $items['admin/mmorpg/reports/blank'] = array(
    'title' => 'Reports',
    'access callback' => TRUE,
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );

  $items['personalization'] = array(
    'page callback' => 'mmorpg_site_personalization_endpoint',
    'access arguments' => array('access content'),
  );

  $items['update_counts'] = array(
    'page callback' => 'mmorpg_site_update_count_endpoint',
    'access arguments' => array('access content'),
  );

  $items['game/%/video/%'] = array(
    'title' => 'Video',
    'access callback' => TRUE,
    'page callback' => 'mmorpg_site_blank',
  );

  $items['game/%/overview'] = array(
    'title' => 'Overview',
    'access callback' => TRUE,
    'page callback' => 'mmorpg_site_blank',
  );

  $items['game/%/videos'] = array(
    'title' => 'Videos',
    'access callback' => TRUE,
    'page callback' => 'mmorpg_site_blank',
  );

  $items['game/%/forum'] = array(
    'title' => 'Forum',
    'access callback' => TRUE,
    'page callback' => 'mmorpg_site_blank',
  );

  $items['game/%/ratings'] = array(
    'title' => 'Ratings',
    'access callback' => TRUE,
    'page callback' => 'mmorpg_site_blank',
  );

  $items['game/%/reviews'] = array(
    'title' => 'Reviews',
    'access callback' => TRUE,
    'page callback' => 'mmorpg_site_blank',
  );

  $items['game/%/screenshots'] = array(
    'title' => 'Screenshots',
    'access callback' => TRUE,
    'page callback' => 'mmorpg_site_blank',
  );


  return $items;
}

/**
 * Implements hook_block_info().
 */
function mmorpg_site_block_info() {
  $blocks['invisible_block'] = array(
    'info' => t('Invisible Block'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function mmorpg_site_block_view($delta = '') {
  $block = array();
  if ($delta == 'invisible_block') {
    $block['content'] = "<div class='placeholder'></div>";
  }
  return $block;
}

/**
 * We have a lot of panel variants where the selection rules depend on urls.
 * Since these urls are not defined, the page title ends up being "page not found"
 * The purpose of this is to create blank pages so that drupal does not return 404.
 *
 * @return string
 */
function mmorpg_site_blank() {
  return '';
}

/**
 * All the navigation content that is personal to the user is to be loaded after
 * the initial page load via ajax.
 */
function mmorpg_site_personalization_endpoint() {
  global $user;
  $play_now_block = module_invoke('mmorpg_signup_now', 'block_view', 'play_now_menu_link');
  $latest_updates_block = module_invoke('views', 'block_view', 'latest_updates-block');

  $output = array(
    'games' => render($play_now_block['content']),
    'reviews' => '',
    'updates' => render($latest_updates_block['content']),
    'videos' => '',
    'community' => '',
    'blogs' => '',
    'tgn' => '',
    'store' => '',
    'username' => '',
  );
  if ($user->uid > 0) {
    $latest_news_block = module_invoke('views', 'block_view', 'trending-latest_news');

    $output['tgn'] = 'Not Implemented';
    $output['blogs'] = 'Not Implemented';
    $output['store'] = 'Not Implemented';
    $output['videos'] = 'Not Implemented';
    $output['reviews'] = 'Not Implemented';
    $output['username'] = render($latest_news_block['content']);
    $output['community'] = 'Not Implemented';
  }
  drupal_json_output($output);
}

/**
 * This returns a list of the recent node ids in various categories
 * so that the browser can compute new content counts.
 */
function mmorpg_site_update_count_endpoint() {
  $dummy_ids = range(1, 20);

  drupal_json_output(array(
    'expires' => time() + 5 * 60 * 60,
    'data' => array(
      'games' => $dummy_ids,
      'reviews' => $dummy_ids,
      'updates' => $dummy_ids,
      'videos' => $dummy_ids,
      'community' => $dummy_ids,
      'blogs' => $dummy_ids,
      'tgn' => $dummy_ids,
      'store' => $dummy_ids,
    ),
  ));
}
